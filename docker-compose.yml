# ==================================
# Consultor.AI - Docker Compose (Production/Staging)
# ==================================

# Docker Compose version is no longer required
# Removed to avoid warning message

services:
  # ----------------------------------
  # Next.js Application
  # ----------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: consultorai-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      
      # Supabase (supports both old and new naming)
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY}
      - SUPABASE_SECRET_KEY=${SUPABASE_SECRET_KEY}
      
      # Google AI
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY}
      - GOOGLE_AI_MODEL=${GOOGLE_AI_MODEL:-gemini-1.5-flash}
      
      # Meta WhatsApp
      - NEXT_PUBLIC_META_APP_ID=${NEXT_PUBLIC_META_APP_ID}
      - META_APP_SECRET=${META_APP_SECRET}
      - META_APP_ACCESS_TOKEN=${META_APP_ACCESS_TOKEN}
      - NEXT_PUBLIC_META_CONFIG_ID=${NEXT_PUBLIC_META_CONFIG_ID}
      - META_WEBHOOK_VERIFY_TOKEN=${META_WEBHOOK_VERIFY_TOKEN}
      
      # Encryption
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Redis
      - REDIS_URL=redis://redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-consultorai_password}
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - consultorai-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # ----------------------------------
  # Redis
  # ----------------------------------
  redis:
    image: redis:7-alpine
    container_name: consultorai-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-consultorai_password} --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - consultorai-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ----------------------------------
  # PostgreSQL (Optional - use if not using Supabase Cloud)
  # ----------------------------------
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: consultorai-postgres
  #   restart: unless-stopped
  #   environment:
  #     POSTGRES_DB: consultorai
  #     POSTGRES_USER: postgres
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres-data:/var/lib/postgresql/data
  #   networks:
  #     - consultorai-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U postgres"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # ----------------------------------
  # Nginx (Reverse Proxy - Optional)
  # ----------------------------------
  # nginx:
  #   image: nginx:alpine
  #   container_name: consultorai-nginx
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./deployment/nginx/ssl:/etc/nginx/ssl:ro
  #   depends_on:
  #     - app
  #   networks:
  #     - consultorai-network

volumes:
  redis-data:
    driver: local
  # postgres-data:
  #   driver: local

networks:
  consultorai-network:
    driver: bridge
    name: consultorai-prod
